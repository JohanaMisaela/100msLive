var p=(r,e,t)=>new Promise((i,s)=>{var d=S=>{try{o(t.next(S))}catch(a){s(a)}},H=S=>{try{o(t.throw(S))}catch(a){s(a)}},o=S=>S.done?i(S.value):Promise.resolve(S.value).then(d,H);o((t=t.apply(r,e)).next())});import{HlsStats as O}from"@100mslive/hls-stats";import E from"hls.js";import u from"hls.js";var L=class extends Error{constructor(e,t,i,s=!1){super(t);this.name=e;this.message=t;this.description=i;this.isTerminal=s;Object.setPrototypeOf(this,L.prototype)}toAnalyticsProperties(){return{error_name:this.name,error_message:this.message,error_description:this.description,is_terminal:this.isTerminal}}addNativeError(e){this.nativeError=e}toString(){var e;return`{
      name: ${this.name};
      message: ${this.message};
      description: ${this.description};
      isTerminal: ${this.isTerminal};
      nativeError: ${(e=this.nativeError)==null?void 0:e.message};
    }`}};var R=5,l;(function(a){a.TIMED_METADATA_LOADED="timed-metadata",a.SEEK_POS_BEHIND_LIVE_EDGE="seek-pos-behind-live-edge",a.CURRENT_TIME="current-time",a.AUTOPLAY_BLOCKED="autoplay-blocked",a.MANIFEST_LOADED="manifest-loaded",a.LAYER_UPDATED="layer-updated",a.ERROR="error",a.PLAYBACK_STATE="playback-state",a.STATS="stats"})(l||(l={}));var m;(function(n){n.MANIFEST_LOAD_ERROR="manifest-load-error",n.MANIFEST_PARSING_ERROR="manifest-parsing-error",n.LAYER_LOAD_ERROR="layer-load-error",n.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifest-incompatible-codecs-error",n.FRAG_DECRYPT_ERROR="frag-decrypt-error",n.BUFFER_INCOMPATIBLE_CODECS_ERROR="buffer-incompatible-codecs-error",n.VIDEO_ELEMENT_NOT_FOUND="video-element-not-found",n.HLS_AUTOPLAY_FAILED="hls-autoplay-failed",n.HLS_URL_NOT_FOUND="hls-url-not-found",n.HLS_ERROR="hls-error"})(m||(m={}));var v;(function(t){t[t.playing=0]="playing",t[t.paused=1]="paused"})(v||(v={}));var h={HLSNetworkError:{manifestLoadError(r){return new L(m.MANIFEST_LOAD_ERROR,r.details,"Unable to load manifest file",r.fatal)},manifestParsingError(r){return new L(m.MANIFEST_PARSING_ERROR,r.details,"Unable to parse manifest file",r.fatal)},layerLoadError(r){return new L(m.LAYER_LOAD_ERROR,r.details,"Unable to load quality layers",r.fatal)}},HLSMediaError:{manifestIncompatibleCodecsError(r){return new L(m.MANIFEST_INCOMPATIBLE_CODECS_ERROR,r.details,"Incompatible manifest codecs",r.fatal)},fragDecryptError(r){return new L(m.FRAG_DECRYPT_ERROR,r.details,"Unable to decrypt fragment",r.fatal)},bufferIncompatibleCodecsError(r){return new L(m.BUFFER_INCOMPATIBLE_CODECS_ERROR,r.details,"Incompatible buffer codecs",r.fatal)},videoElementNotFound(){return new L(m.VIDEO_ELEMENT_NOT_FOUND,"Video element not found","Video element not found",!1)},autoplayFailed(){return new L(m.HLS_AUTOPLAY_FAILED,"Failed to autoplay","Failed to autoplay",!1)},hlsURLNotFound(r){return new L(m.HLS_URL_NOT_FOUND,r||"hls url not found",r||"hls url not found",!0)}},HLSError:(r,e=m.HLS_ERROR,t="Hls error")=>new L(e,r.details,t,r.fatal)};var y=r=>{try{let e=window==null?void 0:window.atob(r);return JSON.parse(e)}catch(e){return{payload:r}}},T=r=>r.map(e=>_(e)),_=r=>{var e;return{resolution:(e=r.attrs)==null?void 0:e.RESOLUTION,bitrate:r.bitrate,height:r.height,id:r.id,url:r.url[0],width:r.width}};var c=class{constructor(e,t,i){this.videoEl=t;this.emitEvent=i;this.extractMetaTextTrack=()=>{let e=this.videoEl.textTracks.length||0;for(let t=0;t<e;t++){let i=this.videoEl.textTracks[t];if((i==null?void 0:i.kind)==="metadata")return i.mode="showing",i}return null};this.fireCues=(e,t)=>{var H;let i=(H=this.extractMetaTextTrack())==null?void 0:H.cues;if(!i)return;let s=i.length,d=0;for(;d<s;){let o=i[d];if(o.queued){d++;continue}let S=y(o.value.data),a=S.start_date,n=S.end_date,M=new Date(a).getTime()-e,D=new Date(n).getTime()-new Date(a).getTime();M<=t&&(setTimeout(()=>{this.emitEvent(l.TIMED_METADATA_LOADED,{id:o==null?void 0:o.id,payload:S.payload,duration:D,startDate:new Date(a),endDate:new Date(n)})},M),o.queued=!0),d++}};this.handleTimeUpdateListener=()=>{var s;let e=this.extractMetaTextTrack();if(!e||!e.cues)return;let t=((s=this.videoEl)==null?void 0:s.getStartDate())||0,i=new Date(t).getTime()+(this.videoEl.currentTime||0)*1e3;this.fireCues(i,.25)};this.fragChangeHandler=(e,{frag:t})=>{if(!this.videoEl){let i=h.HLSMediaError.videoElementNotFound();this.emitEvent(l.ERROR,i)}try{if(this.videoEl.textTracks.length===0)return;let i=t.programDateTime||0,s=t.end-t.start;this.fireCues(i,s)}catch(i){console.error("FRAG_CHANGED event error",i)}};this.registerListner=()=>{u.isSupported()?this.hls.on(u.Events.FRAG_CHANGED,this.fragChangeHandler):this.videoEl.canPlayType("application/vnd.apple.mpegurl")&&this.videoEl.addEventListener("timeupdate",this.handleTimeUpdateListener)};this.unregisterListener=()=>{this.hls.off(u.Events.FRAG_CHANGED,this.fragChangeHandler),this.videoEl.removeEventListener("timeupdate",this.handleTimeUpdateListener)};this.hls=e,this.registerListner()}};import{EventEmitter2 as P}from"eventemitter2";var f=class{constructor(){this.eventEmitter=new P}on(e,t){this.eventEmitter.on(e,t)}off(e,t){this.eventEmitter.off(e,t)}emitEvent(e,t){return this.eventEmitter.emit(e,t,e)}removeAllListeners(e){this.eventEmitter.removeAllListeners(e)}};var A=class{constructor(e,t){this._subscribeHlsStats=null;this.TAG="[HMSHLSPlayer]";this.subscribeStats=(e=2e3)=>{this._subscribeHlsStats=this._hlsStats.subscribe(t=>{this.emitEvent(l.STATS,t)},e)};this.unsubscribeStats=()=>{this._subscribeHlsStats&&this._subscribeHlsStats()};this.on=(e,t)=>{this._emitter.on(e,t)};this.off=(e,t)=>{this._emitter.off(e,t)};this.emitEvent=(e,t)=>{var i,s;if(e===l.ERROR){let d=t;(d==null?void 0:d.isTerminal)&&((s=(i=window==null?void 0:window.__hms)==null?void 0:i.sdk)==null||s.sendHLSAnalytics(d))}return this._emitter.emitEvent(e,t)};this.removeAllListeners=e=>{this._emitter.removeAllListeners(e)};this.play=()=>p(this,null,function*(){yield this.playVideo()});this.pause=()=>{this.pauseVideo()};this.seekTo=e=>{this._videoEl.currentTime=e};this.playVideo=()=>p(this,null,function*(){try{this._videoEl.paused&&(yield this._videoEl.play())}catch(e){console.debug(this.TAG,"Play failed with error",e.message),e.name==="NotAllowedError"&&this.emitEvent(l.AUTOPLAY_BLOCKED,h.HLSMediaError.autoplayFailed())}});this.pauseVideo=()=>{this._videoEl.paused||this._videoEl.pause()};this.playEventHandler=()=>{this.emitEvent(l.PLAYBACK_STATE,{state:v.playing})};this.pauseEventHandler=()=>{this.emitEvent(l.PLAYBACK_STATE,{state:v.paused})};this.volumeEventHandler=()=>{this._volume=this._videoEl.volume};this.handleHLSException=(e,t)=>{var d,H;console.error(this.TAG,`error type ${t.type} with details ${t.details} is fatal ${t.fatal}`);let s={details:((d=t.error)==null?void 0:d.message)||((H=t.err)==null?void 0:H.message)||"",fatal:t.fatal};switch(t.details){case E.ErrorDetails.MANIFEST_INCOMPATIBLE_CODECS_ERROR:{let o=h.HLSMediaError.manifestIncompatibleCodecsError(s);this.emitEvent(l.ERROR,o);break}case E.ErrorDetails.FRAG_DECRYPT_ERROR:{let o=h.HLSMediaError.fragDecryptError(s);this.emitEvent(l.ERROR,o);break}case E.ErrorDetails.BUFFER_INCOMPATIBLE_CODECS_ERROR:{let o=h.HLSMediaError.bufferIncompatibleCodecsError(s);this.emitEvent(l.ERROR,o);break}case E.ErrorDetails.MANIFEST_LOAD_ERROR:{let o=h.HLSNetworkError.manifestLoadError(s);this.emitEvent(l.ERROR,o);break}case E.ErrorDetails.MANIFEST_PARSING_ERROR:{let o=h.HLSNetworkError.manifestParsingError(s);this.emitEvent(l.ERROR,o);break}case E.ErrorDetails.LEVEL_LOAD_ERROR:{let o=h.HLSNetworkError.layerLoadError(s);this.emitEvent(l.ERROR,o);break}default:{let o=h.HLSError(s,t.type,t.details);this.emitEvent(l.ERROR,o);break}}};this.manifestLoadedHandler=(e,{levels:t})=>{let i=T(this.removeAudioLevels(t));this.emitEvent(l.MANIFEST_LOADED,{layers:i})};this.levelUpdatedHandler=(e,{level:t})=>{let i=_(this._hls.levels[t]);this.emitEvent(l.LAYER_UPDATED,{layer:i})};this.handleTimeUpdateListener=e=>{this.emitEvent(l.CURRENT_TIME,this._videoEl.currentTime);let t=this._hls.liveSyncPosition?this._hls.liveSyncPosition-this._videoEl.currentTime<=R:!1;this._isLive!==t&&(this._isLive=t,this.emitEvent(l.SEEK_POS_BEHIND_LIVE_EDGE,{isLive:this._isLive}))};if(this._hls=new E(this.getPlayerConfig()),this._emitter=new f,this._hlsUrl=e,this._videoEl=t||this.createVideoElement(),e){if(!e.endsWith("m3u8"))throw h.HLSMediaError.hlsURLNotFound("Invalid URL, pass m3u8 url")}else throw h.HLSMediaError.hlsURLNotFound();this._hls.loadSource(e),this._hls.attachMedia(this._videoEl),this._isLive=!0,this._volume=this._videoEl.volume*100,this._hlsStats=new O(this._hls,this._videoEl),this.listenHLSEvent(),this._metaData=new c(this._hls,this._videoEl,this.emitEvent),this.seekToLivePosition()}createVideoElement(){if(this._videoEl)return this._videoEl;let e=document.createElement("video");return e.playsInline=!0,e.controls=!1,e.autoplay=!0,e}getVideoElement(){return this._videoEl}reset(){this._hls&&this._hls.media&&(this._hls.detachMedia(),this.unsubscribeStats()),this._metaData&&this._metaData.unregisterListener(),E.isSupported()&&(this._hls.off(E.Events.MANIFEST_LOADED,this.manifestLoadedHandler),this._hls.off(E.Events.LEVEL_UPDATED,this.levelUpdatedHandler),this._hls.off(E.Events.ERROR,this.handleHLSException)),this._videoEl&&(this._videoEl.removeEventListener("play",this.playEventHandler),this._videoEl.removeEventListener("pause",this.pauseEventHandler),this._videoEl.removeEventListener("timeupdate",this.handleTimeUpdateListener),this._videoEl.removeEventListener("volumechange",this.volumeEventHandler)),this.removeAllListeners()}get volume(){return this._volume}setVolume(e){this._videoEl.volume=e/100,this._volume=e}getLayer(){var e,t;if(this._hls&&this._hls.currentLevel!==-1){let i=(t=this._hls)==null?void 0:t.levels.at((e=this._hls)==null?void 0:e.currentLevel);return i?_(i):null}return null}setLayer(e){if(this._hls){let t=this._hls.levels.findIndex(i=>{var s;return((s=i==null?void 0:i.attrs)==null?void 0:s.RESOLUTION)===(e==null?void 0:e.resolution)});this._hls.currentLevel=t}}seekToLivePosition(){return p(this,null,function*(){let e=0;if(this._videoEl.buffered.length>0&&(e=this._videoEl.buffered.end(this._videoEl.buffered.length-1)),this._videoEl.currentTime=this._hls.liveSyncPosition||e,this._videoEl.paused)try{yield this.playVideo()}catch(t){console.error(this.TAG,"Attempt to jump to live position Failed.",t)}})}listenHLSEvent(){E.isSupported()?(this._hls.on(E.Events.MANIFEST_LOADED,this.manifestLoadedHandler),this._hls.on(E.Events.LEVEL_UPDATED,this.levelUpdatedHandler),this._hls.on(E.Events.ERROR,this.handleHLSException),this.subscribeStats()):this._videoEl.canPlayType("application/vnd.apple.mpegurl")&&(this._videoEl.src=this._hlsUrl),this._videoEl.addEventListener("timeupdate",this.handleTimeUpdateListener),this._videoEl.addEventListener("play",this.playEventHandler),this._videoEl.addEventListener("pause",this.pauseEventHandler),this._videoEl.addEventListener("volumechange",this.volumeEventHandler)}getPlayerConfig(){return{enableWorker:!0,maxBufferLength:20,backBufferLength:10,abrBandWidthUpFactor:1}}removeAudioLevels(e){return e.filter(({videoCodec:t,width:i,height:s})=>!!t||!!(i&&s))}};export{v as HLSPlaybackState,A as HMSHLSPlayer,l as HMSHLSPlayerEvents};
//# sourceMappingURL=index.js.map
